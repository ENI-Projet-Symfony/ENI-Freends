{% extends 'base.html.twig' %}

{% block title %}{{ sortie.nom }} | {{ parent() }}{% endblock %}
{% block stylesheets %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin="" />
    <style type="text/css">
        #map{ /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            height:400px;
        }
    </style>

{% endblock %}

{% block body %}
    <section class="row">
        <h1>Détails : {{ sortie.nom }}</h1>


        <article class="col-7">
            <div class="card ">
                <div class="card-header row">
                    <div class="col-4">
                        <h4 class="card-title">{{ sortie.nom }}</h4>
                        <h6 class="card-subtitle mb-2 text-muted">{{ sortie.campus.nom}}, {{ sortie.etat.libelle }}</h6>
                    </div>
                    <div class="col-4 text-center">
                        <p class="card-text">{{ sortie.lieu.nom }}</p>
                    </div>
                    <div class="col-4 text-end">
                        <p class="card-text">Commence le {{ sortie.dateHeureDebut |format_datetime(pattern="dd MMMM à HH:mm") }}</p>
                        <p class="card-text">Durée : {{ sortie.duree }} minutes</p>
                    </div>
                </div>
                <div class="card-body row">
                    {% if(sortie.urlPhoto) %}
                        <div class="col-6">
                            <img
                                    src="{{ asset('img/small/' ~ sortie.urlPhoto) }}"
                                    alt="..."
                                    class="img-fluid"
                            />
                        </div>
                        <div class="col-6">
                            <p class="card-text">{{ sortie.infosSortie }}</p>
                        </div>
                    {% else %}
                    <p class="card-text">{{ sortie.infosSortie }}</p>
                    {% endif %}
                </div><!-- End .card-body -->
                <div class="card-footer row">
                    <div class="col-6">

                        <p class="card-text">Date limite inscriptions : {{ sortie.dateLimiteInscription |format_datetime(pattern="dd MMMM") }}</p>
                    </div>
                    <div class="col-6 text-end">
                        <p class="card-text">Organisateur : {{ sortie.organisateur.pseudo }}</p>
                    </div>
                    <div class="progress mt-1 mb-0" style="height: 7px;">
                        <div class="progress-bar bg-primary" role="progressbar" style="width: {{ sortie.participants.count*100/sortie.nbInscriptionsMax }}%" aria-valuenow="{{ sortie.nbInscriptionsMax }}" aria-valuemin="0" aria-valuemax="{{ sortie.participants.count }}"></div>
                    </div>
                    <p class="card-text">Participants : {{ sortie.participants.count }}/{{ sortie.nbInscriptionsMax }}</p>
                </div>
            </div><!-- End .card -->
        </article>
        <article class="col-5">
            <div id="map">
                <!-- Ici s'affichera la carte -->
            </div>

            <div class="panel panel-primary">
                <div class="panel-heading">
                    <h5>Adresse :</h5>
                </div>
                <div class="panel-body">
                    <p>{{ sortie.lieu.rue }}</p>
                    <p>{{ sortie.lieu.ville.codePostal }} {{ sortie.lieu.ville.nom }}</p>
                </div>
            </div>
            <div class="panel panel-primary">
                <div class="panel-heading"><h5>Participants :</h5></div>
                {% if(sortie.participants.count > 0) %}
                <div class="panel-body table-fixed">
                    <table class="table">
                        <thead>
                        <tr>
                            <th scope="col" class="col-4">Pseudo</th>
                            <th scope="col" class="col-4">Nom</th>
                            <th scope="col" class="col-4">Détails</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for participant in sortie.participants %}
                        <tr>
                            <th scope="row">{{ participant.pseudo }}</th>
                            <td>{{ participant.nom }} {{ participant.prenom }}</td>
                            <td><a class="nav-link" href="{{ path('participant_profil' , {id : participant.id}) }}">Afficher</a></td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="panel-body">Il n'y a pas encore de participants inscrit à cette sortie</div>
                {% endif %}
            </div>
        </article>
    </section>


{#    <a class="nav-link" href="{{ path('participant_profil' , {id : app.user.id}) }}">Mon profil</a>#}
{% endblock %}
{% block javascripts %}
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw==" crossorigin=""></script>
    <script type="text/javascript">
        // On initialise la latitude et la longitude de Paris (centre de la carte)
        var lat = {{ sortie.lieu.latitude }};
        var lon = {{ sortie.lieu.longitude }};
        var macarte = null;
        // Fonction d'initialisation de la carte
        function initMap() {


            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lon], 11);
            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a>',
                minZoom: 1,
                maxZoom: 20
            }).addTo(macarte);
            var myIcon = L.icon({
                iconUrl:  '{{ asset('img/map/map-marker-icon.png') }}',
                iconSize: [50, 50],
                iconAnchor: [25, 50],
                popupAnchor: [-3, -76],
            });
            var marker = L.marker([lat, lon], {icon:myIcon}).addTo(macarte);
        }
        window.onload = function(){
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
        };
    </script>

{% endblock %}
